language: java
#jdk:
#  - openjdk11

jobs:
  include:
    - os: linux
      env:
        - JAVA_HOME="$HOME/.sdkman/candidates/java/current"
        - MVN=./mvnw
        - GU=gu
        - NATIVEIMAGE=native-image
        - TARGET=teamscale-upload
    - os: windows
      language: shell
      env: 
        - JAVA_HOME="$HOME/.sdkman/candidates/java/current"
        - MVN=./mvnw.cmd
        - GU="$JAVA_HOME/bin/gu.cmd"
        - NATIVEIMAGE="$JAVA_HOME/bin/native-image.cmd"
        - TARGET=teamscale-upload.exe

# install SDKMAN
before_install:
  - if [ $TRAVIS_OS_NAME = windows ]; then choco install zip unzip -y ; fi
  # adding $HOME/.sdkman to cache would create an empty directory, which interferes with the initial installation
  - "[[ -d $HOME/.sdkman/ ]] && [[ -d $HOME/.sdkman/bin/ ]] || rm -rf $HOME/.sdkman/"
  - curl -sL https://get.sdkman.io | bash
  - mkdir -p "$HOME/.sdkman/etc/"
  - echo sdkman_auto_answer=true > "$HOME/.sdkman/etc/config"
  - echo sdkman_auto_selfupdate=true >> "$HOME/.sdkman/etc/config"
  - "source $HOME/.sdkman/bin/sdkman-init.sh"

# install GraalVM java
install:
  - sdk current java | grep '20.2.0.r11-grl' || sdk install java 20.2.0.r11-grl
  - $GU install native-image
  - $NATIVEIMAGE --version

before_script:
  - chmod +x mvnw
script:
  - $MVN --version
  - if [ $TRAVIS_OS_NAME = windows ]; then ./build-windows.bat ; fi
  - if [ $TRAVIS_OS_NAME != windows ]; then $MVN clean package ; fi
  - (cd ./target; zip teamscale-upload-$TRAVIS_OS_NAME.zip "./$TARGET")

deploy:
  provider: releases
  api_key:
    secure: On+wFJOvh7Cidb4GaNrEtkC9ZaQCGaItIJROeyDWXnIqdA2MTO7KYLlBlwD3UaZwqSiq29BmCyza9qbWUCXwhxxYBWZsAqjB1sCbydAKpE4EXrRmnlyjnbTTZzOQEuq49vdkYMzghQlXthlEoCHROs25WiboAtA70uusCHsUnQyGkcLAqYq7JYhZd77u5Ef8wyR/IFN6lBKfwIMvoOSeVCUrOhYT+2NBqa23G7vt55oD41O+KFTnSSc1LdXf0geFGC4b3CQXLuWvoRoJ4XJHNj4gfq6ziq5CJh+mInh/VwtZaR2wPZaaEipOdF3mBpPghHYoIiZ24PaZcUONG9qAvJKekgLpiQOYglBjRaApY6SOV/glUEO2RGIyV0ftxY1dt/DRH1xg8eMNmr2H22xRh7X5h1pHP6MvBe5+JnmCdX0/sLMgXet7B/oorsTx6SpHs4A6icuZc054rE9igD2xGWBajONxHRATc4dMooCoVIvwhs6Kymil1r6/vzaaSJ+OhJPezOpVq8TuoxIa+MmB1LNN6o5Oa6IY7wxr9/0RszB4qfpPYWKaNOWL6OZonh6/NO258jCFHumRjG0adeqKMAG8xY47Z83EnQIRjR2u+OMb8+IWQJuakQFABHPern2o1uqhA6pMTHTizRQqrv7xe4hjOxUD5DBYMI2Dj43c2OY=
  file:
    - target/teamscale-upload-*.zip
  file_glob: true
  on:
    tags: true
    repo: cqse/teamscale-upload
  skip_cleanup: true

